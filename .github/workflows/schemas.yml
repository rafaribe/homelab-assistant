name: Publish Schemas

on:
  push:
    branches: ["main"]
    paths: ["api/**", "config/crd/**"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  publish-schemas:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install mise
        uses: jdx/mise-action@v2
        with:
          install: true
          cache: true

      - name: Generate schemas
        run: mise run generate-schemas

      - name: Create index page
        run: |
          cat > _site/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Homelab Assistant - CRD Schemas</title>
              <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
              <style>
                  .hero { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
                  .schema-card { transition: transform 0.2s; }
                  .schema-card:hover { transform: translateY(-5px); }
              </style>
          </head>
          <body>
              <div class="hero py-5">
                  <div class="container text-center">
                      <h1 class="display-4">üè† Homelab Assistant</h1>
                      <p class="lead">Kubernetes Custom Resource Definitions</p>
                      <a href="https://github.com/rafaribe/homelab-assistant" class="btn btn-light btn-lg">
                          View on GitHub
                      </a>
                  </div>
              </div>

              <div class="container my-5">
                  <div class="row">
                      <div class="col-md-8">
                          <h2>üìã Available Schemas</h2>
                          <p class="text-muted">OpenAPI schemas for Homelab Assistant Custom Resource Definitions</p>
                          
                          <div class="row">
                              <div class="col-md-6 mb-3">
                                  <div class="card schema-card h-100">
                                      <div class="card-body">
                                          <h5 class="card-title">VolSyncMonitor</h5>
                                          <p class="card-text text-muted">homelab.rafaribe.com</p>
                                          <a href="./schemas/homelab.rafaribe.com_volsyncmonitors.yaml" class="btn btn-primary btn-sm">
                                              üìÑ View Schema
                                          </a>
                                      </div>
                                  </div>
                              </div>
                              <div class="col-md-6 mb-3">
                                  <div class="card schema-card h-100">
                                      <div class="card-body">
                                          <h5 class="card-title">VolSyncUnlock</h5>
                                          <p class="card-text text-muted">homelab.rafaribe.com</p>
                                          <a href="./schemas/homelab.rafaribe.com_volsyncunlocks.yaml" class="btn btn-primary btn-sm">
                                              üìÑ View Schema
                                          </a>
                                      </div>
                                  </div>
                              </div>
                          </div>
                      </div>
                      
                      <div class="col-md-4">
                          <div class="card">
                              <div class="card-header">
                                  <h5>üöÄ Quick Install</h5>
                              </div>
                              <div class="card-body">
                                  <p>Install all CRDs:</p>
                                  <pre><code>kubectl apply -f https://rafaribe.github.io/homelab-assistant/schemas/</code></pre>
                                  
                                  <p class="mt-3">Install specific CRD:</p>
                                  <pre><code>kubectl apply -f https://rafaribe.github.io/homelab-assistant/schemas/homelab.rafaribe.com_volsyncmonitors.yaml</code></pre>
                              </div>
                          </div>
                          
                          <div class="card mt-3">
                              <div class="card-header">
                                  <h5>üìñ Documentation</h5>
                              </div>
                              <div class="card-body">
                                  <ul class="list-unstyled">
                                      <li><a href="https://github.com/rafaribe/homelab-assistant/blob/main/README.md">README</a></li>
                                      <li><a href="https://github.com/rafaribe/homelab-assistant/blob/main/VOLSYNC_MONITOR.md">VolSync Monitor</a></li>
                                      <li><a href="https://github.com/rafaribe/homelab-assistant/tree/main/examples">Examples</a></li>
                                  </ul>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>

              <footer class="bg-light py-4 mt-5">
                  <div class="container text-center text-muted">
                      <p>Generated on <span id="timestamp"></span> | 
                         <a href="https://github.com/rafaribe/homelab-assistant">Homelab Assistant</a></p>
                  </div>
              </footer>

              <script>
                  document.getElementById('timestamp').textContent = new Date().toLocaleString();
              </script>
          </body>
          </html>
          EOF

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
